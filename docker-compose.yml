services:
  # Database (internal only)
  postgres-db:
    image: postgres:16-alpine
    container_name: crypto_postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: crypto_main
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # No port exposure - internal only

    # API Gateway - Single entry point for backend (TLS termination)
  api-gateway:
    build: services/api-gateway
    container_name: api_gateway
    ports:
      - "8080:8080" # Only exposed backend port
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      # mTLS configuration (optional - can enable later)
      - SSL_ENABLED=false
    volumes:
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db
      - identity-service
      - ca-authority
      - cloud-sign
      - validation-service

  # Internal Backend Services (no port exposure, mTLS enabled)
  identity-service:
    build: services/identity-service
    container_name: identity_service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/crypto_main
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=password
    volumes:
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db

  ca-authority:
    build: services/ca-authority
    container_name: ca_authority
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    volumes:
      - ca-keys:/secure/ca
      - mtls-certs:/secure/mtls
    depends_on:
      - postgres-db

  ra-service:
    build: services/ra-service
    container_name: ra_service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    volumes:
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db

  cloud-sign:
    build: services/cloud-sign
    container_name: cloud_sign
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    volumes:
      - cloud-sign-keys:/secure/keys
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db

  validation-service:
    build: services/validation-service
    container_name: validation_service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    volumes:
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db

  signature-core:
    build: services/signature-core
    container_name: signature_core
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/crypto_main
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=password
    volumes:
      - mtls-certs:/app/certs:ro
    depends_on:
      - postgres-db

  # Frontend Applications (publicly exposed)
  public-portal:
    build: apps/public-portal
    container_name: public_portal
    ports:
      - "3000:3000"
    environment:
      - NUXT_PUBLIC_API_BASE=http://localhost:8080/api/v1
    depends_on:
      - api-gateway

  admin-portal:
    build: apps/admin-portal
    container_name: admin_portal
    ports:
      - "3001:3000"
    environment:
      - NUXT_PUBLIC_API_BASE=http://localhost:8080/api/v1
    depends_on:
      - api-gateway

volumes:
  postgres_data:
  ca-keys:
  cloud-sign-keys:
  mtls-certs:
