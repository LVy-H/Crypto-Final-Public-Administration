# ============================================================================
# Kubernetes Network Policies - Security Zone Enforcement
# ============================================================================
#
# ZONES:
#   Zone A (Public/DMZ):  public-portal, admin-portal, rssp-gateway
#   Zone B (Internal):    api-gateway, identity-service, validation-service,
#                         doc-service, org-service, signature-core
#   Zone C (Secure):      ca-authority, cloud-sign, softhsm (air-gapped)
#
# RULES:
#   - Zone A can only talk to api-gateway (Zone B ingress)
#   - Zone B services can talk to each other
#   - Zone C only accepts traffic from specific Zone B services
#   - HSM (Zone C) is air-gapped: only cloud-sign and ca-authority can access
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: crypto-pqc
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  # Default: deny all traffic, then explicitly allow
  ingress: []
  egress:
    # Allow DNS resolution
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# ============================================================================
# ZONE A: Public/DMZ - Portal access policies
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-portal-ingress
  namespace: crypto-pqc
  labels:
    zone: public
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow external ingress (from ingress controller)
    - from: []
      ports:
        - protocol: TCP
          port: 3000
  egress:
    # Portals can only talk to api-gateway
    - to:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8080
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
# ============================================================================
# ZONE B: Internal - Core microservices policies
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-gateway
  namespace: crypto-pqc
  labels:
    zone: internal
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Accept from portals and external ingress
    - from:
        - podSelector:
            matchLabels:
              tier: frontend
      ports:
        - protocol: TCP
          port: 8080
    # Accept from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Can talk to all internal services
    - to:
        - podSelector:
            matchLabels:
              tier: backend
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8081
        - protocol: TCP
          port: 8082
        - protocol: TCP
          port: 8083
        - protocol: TCP
          port: 8084
        - protocol: TCP
          port: 8085
        - protocol: TCP
          port: 8086
    # Allow DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-services
  namespace: crypto-pqc
  labels:
    zone: internal
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Accept from api-gateway
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
    # Accept from other backend services (internal mesh)
    - from:
        - podSelector:
            matchLabels:
              tier: backend
  egress:
    # Can talk to database
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Can talk to other backend services
    - to:
        - podSelector:
            matchLabels:
              tier: backend
    # Can talk to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # Secure zone services can talk to HSM
    - to:
        - podSelector:
            matchLabels:
              zone: secure
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
# ============================================================================
# ZONE C: Secure - Cryptographic services (air-gapped)
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ca-authority
  namespace: crypto-pqc
  labels:
    zone: secure
spec:
  podSelector:
    matchLabels:
      app: ca-authority
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Only accept from specific internal services
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - api-gateway
                  - signature-core
                  - validation-service
                  - cloud-sign
      ports:
        - protocol: TCP
          port: 8082
    # Allow external ingress
    - from: []
      ports:
        - protocol: TCP
          port: 8082
  egress:
    # Can talk to database
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Can talk to CA HSM
    - to:
        - podSelector:
            matchLabels:
              app: softhsm-ca
    # Can talk to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cloud-sign
  namespace: crypto-pqc
  labels:
    zone: secure
spec:
  podSelector:
    matchLabels:
      app: cloud-sign
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Only accept from rssp-gateway and api-gateway
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - api-gateway
                  - rssp-gateway
                  - doc-service
      ports:
        - protocol: TCP
          port: 8084
    # Allow external ingress
    - from: []
      ports:
        - protocol: TCP
          port: 8084
  egress:
    # Can talk to database
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Can talk to User HSM
    - to:
        - podSelector:
            matchLabels:
              app: softhsm-user
    # Can talk to identity-service for token validation
    - to:
        - podSelector:
            matchLabels:
              app: identity-service
      ports:
        - protocol: TCP
          port: 8081
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-hsm-air-gapped
  namespace: crypto-pqc
  labels:
    zone: secure
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - softhsm-user
          - softhsm-ca
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # AIR-GAPPED: Only ca-authority and cloud-sign can access HSM
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - ca-authority
                  - cloud-sign
                  - tsa-mock
      # PKCS#11 over TCP (if using network HSM simulation)
      # For SoftHSM sidecar, this is internal communication
  egress:
    # HSM has NO egress - truly air-gapped
    # Only DNS for internal resolution
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
# ============================================================================
# Database Policy - Only internal services can access
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres
  namespace: crypto-pqc
  labels:
    zone: internal
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    # Only backend tier can access database
    - from:
        - podSelector:
            matchLabels:
              tier: backend
      ports:
        - protocol: TCP
          port: 5432
    # Secure zone services can access database
    - from:
        - podSelector:
            matchLabels:
              zone: secure
      ports:
        - protocol: TCP
          port: 5432
