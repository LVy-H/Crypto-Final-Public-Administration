# WireGuard Tunnel Proxy
# Handles VPN tunnel and DNAT to nginx-ingress controller
# Uses postStart hook to dynamically discover nginx-ingress pod IP via K8s API

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wg-proxy
  namespace: ingress-nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wg-proxy
  template:
    metadata:
      labels:
        app: wg-proxy
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      serviceAccountName: ingress-nginx

      containers:
        # WireGuard VPN + dynamic DNAT setup
        - name: wireguard
          image: linuxserver/wireguard:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN", "SYS_MODULE"]
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "Asia/Ho_Chi_Minh"
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    # Add default route (required for hostNetwork to reach internet)
                    ip route add default via 172.18.0.1 dev eth0 2>/dev/null || true
                    # Wait for WireGuard interface to be created
                    sleep 10
                    # Get nginx-ingress pod IP via K8s API
                    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null)
                    if [ -n "$TOKEN" ]; then
                      NGINX_IP=$(wget -qO- --header="Authorization: Bearer $TOKEN" --no-check-certificate \
                        "https://kubernetes.default.svc/api/v1/namespaces/ingress-nginx/pods?labelSelector=app.kubernetes.io/name=ingress-nginx" 2>/dev/null \
                        | grep -o '"podIP":"[^"]*"' | head -1 | cut -d'"' -f4)
                    fi
                    # Fallback: try curl if wget grep failed
                    if [ -z "$NGINX_IP" ] || [ "$NGINX_IP" = "null" ]; then
                      NGINX_IP=$(curl -sk --header "Authorization: Bearer $TOKEN" \
                        "https://kubernetes.default.svc/api/v1/namespaces/ingress-nginx/pods?labelSelector=app.kubernetes.io/name=ingress-nginx" 2>/dev/null \
                        | grep -o '"podIP":"[^"]*"' | head -1 | cut -d'"' -f4)
                    fi
                    # Final fallback
                    if [ -z "$NGINX_IP" ] || [ "$NGINX_IP" = "null" ]; then
                      echo "WARNING: Could not discover nginx-ingress IP, using fallback"
                      NGINX_IP="10.244.0.39"
                    fi
                    echo "Setting up DNAT to nginx-ingress at $NGINX_IP"
                    # Clear any existing DNAT rules for ports 80/443 on wg0
                    iptables -t nat -F PREROUTING 2>/dev/null || true
                    # Re-add KUBE-SERVICES chain
                    iptables -t nat -A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES 2>/dev/null || true
                    # Insert DNAT rules at position 1 (before KUBE-SERVICES)
                    iptables -t nat -I PREROUTING 1 -i wg0 -p tcp --dport 80 -j DNAT --to-destination ${NGINX_IP}:80
                    iptables -t nat -I PREROUTING 1 -i wg0 -p tcp --dport 443 -j DNAT --to-destination ${NGINX_IP}:443
                    # Accept forwarded traffic
                    iptables -I FORWARD 1 -p tcp -d ${NGINX_IP} -j ACCEPT
                    echo "DNAT rules configured for $NGINX_IP"
          volumeMounts:
            - name: wireguard-config
              mountPath: /config/wg_confs
            - name: lib-modules
              mountPath: /lib/modules
              readOnly: true
          resources:
            limits:
              memory: "128Mi"
              cpu: "100m"
            requests:
              memory: "64Mi"
              cpu: "50m"

      volumes:
        - name: wireguard-config
          secret:
            secretName: wireguard-config
        - name: lib-modules
          hostPath:
            path: /lib/modules
            type: Directory
