# WireGuard Tunnel Proxy with Dynamic DNAT
# Includes sidecar container that monitors nginx-ingress pod IP and updates iptables DNAT
# This ensures routing works even when nginx-ingress pod restarts and gets a new IP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wg-proxy
  namespace: ingress-nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wg-proxy
  template:
    metadata:
      labels:
        app: wg-proxy
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      serviceAccountName: ingress-nginx

      containers:
        # WireGuard VPN container
        - name: wireguard
          image: linuxserver/wireguard:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN", "SYS_MODULE"]
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "Asia/Ho_Chi_Minh"
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    # Add default route (required for hostNetwork to reach internet)
                    ip route add default via 172.18.0.1 dev eth0 2>/dev/null || true
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - ip link del wg0 2>/dev/null || true
          volumeMounts:
            - name: wireguard-config
              mountPath: /config/wg_confs
            - name: lib-modules
              mountPath: /lib/modules
              readOnly: true
          resources:
            limits:
              memory: "128Mi"
              cpu: "100m"
            requests:
              memory: "64Mi"
              cpu: "50m"

        # DNAT Manager sidecar - monitors nginx-ingress IP and updates iptables
        - name: dnat-manager
          image: linuxserver/wireguard:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN"]
          command:
            - /bin/sh
            - -c
            - |
              # Add default route (required for hostNetwork to reach K8s API)
              # Add default route (required for hostNetwork to reach K8s API)
              ip route add default via 172.18.0.1 dev eth0 2>/dev/null || true

              CURRENT_IP=""

              while true; do
                # Get nginx-ingress Pod IP via K8s API
                TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null)
                if [ -n "$TOKEN" ]; then
                  NGINX_IP=$(curl -sk --header "Authorization: Bearer $TOKEN" \
                    "https://10.96.0.1/api/v1/namespaces/ingress-nginx/pods?labelSelector=app=nginx-pqc-ingress" 2>/dev/null \
                    | grep -o '"podIP": *"[^"]*"' | head -1 | sed 's/"podIP": *"\([^"]*\)"/\1/')
                fi
                
                # Only update if IP changed and is valid
                if [ -n "$NGINX_IP" ] && [ "$NGINX_IP" != "null" ] && [ "$NGINX_IP" != "$CURRENT_IP" ]; then
                  echo "$(date): nginx-ingress IP changed from $CURRENT_IP to $NGINX_IP"
                  
                  # Clear existing DNAT rules for wg0
                  iptables -t nat -S PREROUTING 2>/dev/null | grep "wg0" | grep DNAT | while read line; do
                    rule=$(echo "$line" | sed 's/^-A/-D/')
                    iptables -t nat $rule 2>/dev/null || true
                  done
                  
                  # Add new DNAT rules
                  iptables -t nat -I PREROUTING 1 -i wg0 -p tcp --dport 443 -j DNAT --to-destination ${NGINX_IP}:443
                  iptables -t nat -I PREROUTING 1 -i wg0 -p tcp --dport 80 -j DNAT --to-destination ${NGINX_IP}:80
                  
                  # Accept forwarded traffic
                  iptables -D FORWARD -p tcp -d ${CURRENT_IP} -j ACCEPT 2>/dev/null || true
                  iptables -I FORWARD 1 -p tcp -d ${NGINX_IP} -j ACCEPT
                  
                  # Re-add KUBE-SERVICES chain if missing
                  iptables -t nat -C PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES 2>/dev/null || \
                    iptables -t nat -A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
                  
                  CURRENT_IP=$NGINX_IP
                  echo "$(date): DNAT updated to $NGINX_IP"
                fi
                
                sleep 10
              done
          resources:
            limits:
              memory: "64Mi"
              cpu: "50m"
            requests:
              memory: "32Mi"
              cpu: "10m"

      volumes:
        - name: wireguard-config
          secret:
            secretName: wireguard-config
        - name: lib-modules
          hostPath:
            path: /lib/modules
            type: Directory
