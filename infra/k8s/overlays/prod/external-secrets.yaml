# ExternalSecrets - Integrates with HashiCorp Vault, AWS Secrets Manager, etc.
# Requires: External Secrets Operator installed in cluster
# https://external-secrets.io/

---
# SecretStore connects to your secrets backend
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: crypto-pqc-prod
spec:
  provider:
    # Option 1: HashiCorp Vault
    vault:
      server: "https://vault.internal.gov.vn:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "crypto-pqc"
          serviceAccountRef:
            name: "crypto-pqc-sa"

    # Option 2: AWS Secrets Manager (uncomment if using AWS)
    # aws:
    #   service: SecretsManager
    #   region: ap-southeast-1
    #   auth:
    #     jwt:
    #       serviceAccountRef:
    #         name: crypto-pqc-sa

---
# ExternalSecret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: crypto-pqc-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: crypto-secrets
    creationPolicy: Owner
  data:
    - secretKey: postgres-username
      remoteRef:
        key: crypto-pqc/database
        property: username
    - secretKey: postgres-password
      remoteRef:
        key: crypto-pqc/database
        property: password

---
# ExternalSecret for JWT signing key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secret
  namespace: crypto-pqc-prod
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: crypto-secrets
    creationPolicy: Merge
  data:
    - secretKey: jwt-secret
      remoteRef:
        key: crypto-pqc/jwt
        property: signing-key

---
# ExternalSecret for mTLS certificates
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mtls-certs
  namespace: crypto-pqc-prod
spec:
  refreshInterval: 12h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: mtls-certs
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: crypto-pqc/mtls
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: crypto-pqc/mtls
        property: private-key
    - secretKey: ca.crt
      remoteRef:
        key: crypto-pqc/mtls
        property: ca-certificate

---
# ServiceAccount for Vault authentication
apiVersion: v1
kind: ServiceAccount
metadata:
  name: crypto-pqc-sa
  namespace: crypto-pqc-prod
  annotations:
    # For AWS IRSA (if using AWS Secrets Manager)
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/crypto-pqc-secrets-role
